<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../CSS/homepage.css" rel="stylesheet" />
    <link rel="icon" href="../CSS/assets/FORUMIX.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alice&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet">
    <title>FORUMIX</title>
</head>
<body>
    <nav class="navbar">
        <a href="https://localhost:8080/HomePage"><img src="../CSS/assets/FORUMIXComplet.png" alt="FORUMIX" class="logo"></a>
        <div class="search-bar">
            <input type="text" placeholder="Search On FORUMIX...">
            <img class="search-icon" src="../CSS/assets/search-icon.png" style="width:25px;height:25px;">
        </div>

        {{if .IsConnect}}
            <div class="newpost">
                <a href="https://localhost:8080/Creation"><img src="../CSS/assets/cross.png" alt="Create A Post" style="width:25px;height:30px;margin-top:5px;"></a>
            </div>
            <div class="username">
                <h1>{{.Username}}</h1>
            </div>
            <a href="https://localhost:8080/Profil">
                <img src="{{.Photo_pdp}}" alt="Account Information" class="profile-pic">
            </a>
            
        {{else}}
            <a href="https://localhost:8080/Authentication">
                <button class="connect-button">Connect</button>
            </a>
        {{end}}
    </nav>
    
    <nav class="sidebar">
        <div class="menu-item" onclick="toggleDropdown()">
            <button class="dropdown-btn">Category <span class="arrow">▼</span></button>
            {{if .IsConnect}}
                <div class="dropdown-content">
                    {{range .Categorie}}
                        <a href="https://localhost:8080/Subject?categorie={{.Name}}">{{.Name}}</a>
                    {{end}}
                </div>
        </div>
            {{else}}
                <div class="dropdown-content">
                    {{range .Categorie}}
                        <a href="https://localhost:8080/Authentication">{{.Name}}</a>
                    {{end}}
                </div>
            {{end}}
        </div>
        <div class="separator1"></div>
        <div class="menu-item" onclick="toggleDropdown()">
            <button class="dropdown-btn">Ressources <span class="arrow">▼</span></button>
            <div class="dropdown-content">
                <a href="https://localhost:8080/Contact">Contact Us</a>
                <a href="https://localhost:8080/FAQ">FAQ</a>
            </div>
        </div>
    </nav>
    

        <div class="container-wrapper">
        <div class="container-scroll">
            {{range .Categorie}}
            <div class="content-box">
                <a href="https://localhost:8080/Subject?categorie={{.Name}}">
                    <img src="{{.Image}}" alt="{{.Name}}">
                    <div class="overlay-text">{{.Name}}</div>
                </a>
            </div>
            {{end}}
        </div>
        </div>

        
        <div class="full-width-section">
        
            {{range .PostsTab}}
                <a href="https://localhost:8080/Post?id={{.ID}}">
                    <div class="full-width-container">
                            <p>{{.Title}}</p> <!-- Affiche le contenu du post -->
                            <br>
                            <small>Category : {{.Categorie}} <br> Username : {{.UserName}} <br></small>
                            <br>
                            <div class="vote-container" data-id="{{.ID}}" data-like-status="{{.UserLikeStatus}}">
                                <button class="vote-button upvote">&#9650;</button>
                                <span class="vote-count">{{.Likes}}</span>
                                <button class="vote-button downvote">&#9660;</button>
                            </div>
                    </div>
                </a> 
                <div class="separator2"></div>
            {{end}}
        
        </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        // Gestion des dropdowns
        let dropdownButtons = document.querySelectorAll(".dropdown-btn");

        dropdownButtons.forEach(button => {
            button.addEventListener("click", function (event) {
                event.stopPropagation();

                let dropdownContent = this.nextElementSibling;
                let arrow = this.querySelector(".arrow");

                document.querySelectorAll(".dropdown-content").forEach(content => {
                    if (content !== dropdownContent) {
                        content.style.display = "none";
                        content.previousElementSibling.querySelector(".arrow").classList.remove("rotate");
                    }
                });

                let isOpen = dropdownContent.style.display === "block";
                dropdownContent.style.display = isOpen ? "none" : "block";
                arrow.classList.toggle("rotate", !isOpen);
            });
        });

        document.addEventListener("click", function (event) {
            if (!event.target.closest(".menu-item")) {
                document.querySelectorAll(".dropdown-content").forEach(content => {
                    content.style.display = "none";
                    content.previousElementSibling.querySelector(".arrow").classList.remove("rotate");
                });
            }
        });

        // Gestion des votes
        document.querySelectorAll('.vote-container').forEach(container => {
            const upvoteBtn = container.querySelector('.upvote');
            const downvoteBtn = container.querySelector('.downvote');
            const voteCount = container.querySelector('.vote-count');
            
            const postId = container.getAttribute('data-id');
            const status = parseInt(container.getAttribute('data-like-status'));

            // Appliquer la couleur en fonction du statut du vote stocké
            if (status === 1) {
                upvoteBtn.style.color = '#2482a2';
            } else if (status === -1) {
                downvoteBtn.style.color = '#2482a2';
            }

            upvoteBtn.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();

                handleVote(postId, "like", upvoteBtn, downvoteBtn, voteCount);
            });

            downvoteBtn.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();

                handleVote(postId, "dislike", downvoteBtn, upvoteBtn, voteCount);
            });
        });

        function handleVote(postId, action, activeBtn, inactiveBtn, voteCount) {
            if (!postId) {
                console.error("Erreur: Impossible de récupérer l'ID du post.");
                return;
            }

            fetch('/like', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `post_id=${postId}&action=${action}`
            })
            .then(response => response.text())
            .then(data => {
                console.log(`Réponse du serveur: ${data}`);
                voteCount.textContent = data;

                // Gestion des couleurs en fonction du vote
                if (activeBtn.style.color === 'rgb(36, 130, 162)') {
                    activeBtn.style.color = 'rgba(0, 0, 0, 0.25)'; 
                } else {
                    activeBtn.style.color = '#2482a2';
                    inactiveBtn.style.color = 'rgba(0, 0, 0, 0.25)';
                }
            })
            .catch(error => console.error('Erreur:', error));
        }
    });
    // Drag to scroll functionality for container-scroll
const containerWrapper = document.querySelector('.container-wrapper');
const containerScroll = document.querySelector('.container-scroll');

let isDragging = false;
let startX;
let scrollLeft;

containerWrapper.addEventListener('mousedown', (e) => {
    isDragging = true;
    containerWrapper.classList.add('grabbing');
    startX = e.pageX;
    scrollLeft = containerWrapper.scrollLeft;
    e.preventDefault(); // Prevent text selection
});

containerWrapper.addEventListener('mouseleave', () => {
    if (isDragging) {
        isDragging = false;
        containerWrapper.classList.remove('grabbing');
    }
});

containerWrapper.addEventListener('mouseup', () => {
    if (isDragging) {
        isDragging = false;
        containerWrapper.classList.remove('grabbing');
    }
});

containerWrapper.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    e.preventDefault();
    const x = e.pageX;
    const walk = (x - startX); // No multiplier for direct 1:1 movement
    containerWrapper.scrollLeft = scrollLeft - walk;
});

// Touch support
containerWrapper.addEventListener('touchstart', (e) => {
    isDragging = true;
    containerWrapper.classList.add('grabbing');
    startX = e.touches[0].pageX;
    scrollLeft = containerWrapper.scrollLeft;
});

containerWrapper.addEventListener('touchend', () => {
    isDragging = false;
    containerWrapper.classList.remove('grabbing');
});

containerWrapper.addEventListener('touchmove', (e) => {
    if (!isDragging) return;
    const x = e.touches[0].pageX;
    const walk = (x - startX);
    containerWrapper.scrollLeft = scrollLeft - walk;
});

// Prevent default touch behavior to avoid page scroll
containerWrapper.addEventListener('touchmove', (e) => {
    if (isDragging) {
        e.preventDefault();
    }
}, { passive: false });
    </script>
</body>
</html>
